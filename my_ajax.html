<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week 10 Assignment</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #div_list div { padding: 5px; border-bottom: 1px dotted #ccc; }
        div { margin: 10px 0; }
        input { margin: 2px 5px; }
        label { display: inline-block; width: 60px; }
    </style>
</head>
<body onload="getProducts()">
    <h2>제품 목록</h2>
    <div id="div_list"></div>
    <button id="btn_list">목록 새로고침</button>

    <hr>
    
    <h2>제품 관리</h2>
    <div>
        <label for="input_id">id :</label>
        <input type="text" id="input_id" placeholder="(조회/수정/삭제 시 사용)" style="width:150px;" />
        <button id="btn_detail">조회하기</button>
    </div>
    <div>
        <label for="input_name">name :</label>
        <input type="text" id="input_name" />
    </div>
    <div>
        <label for="input_category">category :</label>
        <input type="text" id="input_category" />
    </div>
    <div>
        <label for="input_price">price :</label>
        <input type="number" id="input_price" />
    </div>
     <div>
        <label for="input_inStock">inStock :</label>
        <input type="checkbox" id="input_inStock" /> (재고 있음)
    </div>
    <br>
    <button id="btn_add">입력하기</button>
    <button id="btn_update">수정하기</button>
    <button id="btn_delete">삭제하기</button>
    <button id="btn_clear" type="button">초기화</button>
    

    <script>
         API_URL = "http://localhost:3000/products";

        function getProducts() {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", API_URL);
            xhr.setRequestHeader("content-type", "application/json");
            xhr.send();
            
            xhr.onload = () => {
                if (xhr.status === 200) {
                    let res = JSON.parse(xhr.response);
                    $("#div_list").html("");
                    res.forEach(function(each) {
                        const stock = each.inStock ? '재고있음' : '재고없음';
                        $("#div_list").append(`<div>${each.id} : ${each.name} [${each.category}] (${each.price}원) - ${stock}</div>`);
                    });
                } else {
                    console.log(xhr.status, xhr.statusText);
                }
            }
        }

        function clearForm() {
            $("#input_id").val("");
            $("#input_name").val("");
            $("#input_category").val("");
            $("#input_price").val("");
            $("#input_inStock").prop('checked', false);
        }

        $(function() {

            $("#btn_list").click(function() {
                getProducts();
            });

            $("#btn_clear").click(function() {
                clearForm();
            });

            $("#btn_detail").click(function() {
                const id = $("#input_id").val();
                if (!id) {
                    alert("ID를 입력하세요.");
                    return;
                }

                const xhr = new XMLHttpRequest();
                xhr.open("GET", API_URL + "/" + id);
                xhr.setRequestHeader("content-type", "application/json");
                xhr.send();

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        let res = JSON.parse(xhr.response);
                        $("#input_name").val(res.name);
                        $("#input_category").val(res.category);
                        $("#input_price").val(res.price);
                        $("#input_inStock").prop('checked', res.inStock);
                    } else {
                        alert("데이터 조회에 실패했습니다.");
                        console.log(xhr.status, xhr.statusText);
                    }
                }
            });

            $("#btn_delete").click(function() {
                const id = $("#input_id").val();
                if (!id) {
                    alert("삭제할 ID를 입력하세요.");
                    return;
                }
                if (!confirm(`[${id}]번 제품을 정말 삭제하시겠습니까?`)) {
                    return;
                }

                const xhr = new XMLHttpRequest();
                xhr.open("DELETE", API_URL + "/" + id);
                xhr.setRequestHeader("content-type", "application/json");
                xhr.send();

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        alert("삭제 성공!");
                        clearForm();
                        getProducts();
                    } else {
                        console.log(xhr.status, xhr.statusText);
                    }
                }
            });

            $("#btn_update").click(function() {
                const id = $("#input_id").val();
                if (!id) {
                    alert("수정할 ID를 입력하세요.");
                    return;
                }

                const xhr = new XMLHttpRequest();
                xhr.open("PUT", API_URL + "/" + id);
                xhr.setRequestHeader("content-type", "application/json");
                
                let data = {
                    name: $("#input_name").val(),
                    category: $("#input_category").val(),
                    price: Number($("#input_price").val()),
                    inStock: $("#input_inStock").is(":checked")
                };
                xhr.send(JSON.stringify(data));

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        alert("수정 성공!");
                        clearForm();
                        getProducts();
                    } else {
                        console.log(xhr.status, xhr.statusText);
                    }
                }
            });

            $("#btn_add").click(function() {
                const name = $("#input_name").val();
                const price = $("#input_price").val();

                if (!name || !price) {
                    alert("제품명과 가격을 모두 입력하세요.");
                    return;
                }

                const xhr = new XMLHttpRequest();
                xhr.open("POST", API_URL);
                xhr.setRequestHeader("content-type", "application/json");
                
                let data = {
                    name: name,
                    category: $("#input_category").val(),
                    price: Number(price),
                    inStock: $("#input_inStock").is(":checked")
                };
                xhr.send(JSON.stringify(data));
                
                xhr.onload = () => {
                    if (xhr.status === 201) { 
                        alert("입력 성공!");
                        clearForm();
                        getProducts();
                    } else {
                        console.log(xhr.status, xhr.statusText);
                    }
                }
            });
        });
    </script>
</body>
</html>